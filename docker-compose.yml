# Docker Compose file for ONOS + Mininet + RAVEN

services:
  onos:
    image: onosproject/onos:2.5.1
    container_name: onos
    ports:
      - "8181:8181" # REST API and GUI
      - "6653:6653" # OpenFlow
    environment:
      - ONOS_APPS=openflow,fwd,proxyarp,gui
    networks:
      - onos-mininet-net
    restart: unless-stopped

  mininet:
    build:
      context: ./mininet
      dockerfile: Dockerfile
    container_name: mininet
    privileged: true
    networks:
      - onos-mininet-net
    volumes:
      - ./topologies:/topologies
      - /lib/modules:/lib/modules
    stdin_open: true
    tty: true
    depends_on:
      - onos
    command: >
      bash -c "service openvswitch-switch start && 
               echo 'OVS started successfully' && 
               echo 'Ready to run topologies!' && 
               echo 'Use: docker exec -it mininet bash' && 
               echo 'Then: mn --custom /topologies/diamond4.py --topo diamond4 --controller remote,ip=onos,port=6653' && 
               tail -f /dev/null"

  raven-controller:
    build:
      context: ./raven-controller
      dockerfile: Dockerfile
    container_name: raven-controller
    networks:
      - onos-mininet-net
    depends_on:
      - onos
    environment:
      - ONOS_URL=http://onos:8181
      - ONOS_USER=onos
      - ONOS_PASSWORD=rocks
    restart: unless-stopped
    command: >
      bash -c "echo 'Waiting for ONOS to start...' && 
               sleep 60 && 
               python raven_controller.py"

networks:
  onos-mininet-net:
    driver: bridge

volumes:
  onos-data:
